@model SistemaGestionHorarios.Models.Horario

@{
    ViewData["Title"] = "Crear Horario";
}

<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-header bg-white py-3 border-bottom-0">
                <div class="d-flex align-items-center">
                    <i class='bx bx-calendar-plus text-primary me-2' style="font-size: 1.5rem;"></i>
                    <h5 class="mb-0 fw-bold">Asignar Nuevo Horario</h5>
                </div>
            </div>
            <div class="card-body p-4 pt-0">
                <form asp-action="Create">
                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div asp-validation-summary="All" class="alert alert-danger border-0 small mb-4"></div>
                    }
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <label asp-for="IdDocente" class="form-label mb-0 d-flex align-items-center">
                                        <i class='bx bx-user me-1'></i> Docente
                                    </label>
                                    <a href="javascript:void(0)" onclick="openQuickAddModal('@Url.Action("Create", "Docentes")', 'IdDocente')" class="text-decoration-none ms-1" title="Nuevo Docente">
                                        <i class='bx bx-plus fw-bold'></i>
                                    </a>
                                </div>
                                <select asp-for="IdDocente" class="form-control" asp-items="ViewBag.IdDocente">
                                    <option value="">-- Seleccione Docente --</option>
                                </select>
                                <span asp-validation-for="IdDocente" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <label asp-for="IdAsignatura" class="form-label mb-0 d-flex align-items-center">
                                        <i class='bx bx-book me-1'></i> Asignatura
                                    </label>
                                    <a href="javascript:void(0)" onclick="openQuickAddModal('@Url.Action("Create", "Asignaturas")', 'IdAsignatura')" class="text-decoration-none ms-1" title="Nueva Asignatura">
                                        <i class='bx bx-plus fw-bold'></i>
                                    </a>
                                </div>
                                <select asp-for="IdAsignatura" class="form-control" asp-items="ViewBag.IdAsignatura">
                                    <option value="">-- Seleccione Asignatura --</option>
                                </select>
                                <span asp-validation-for="IdAsignatura" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <label asp-for="IdAula" class="form-label mb-0 d-flex align-items-center">
                                        <i class='bx bx-door-open me-1'></i> Aula
                                    </label>
                                    <a href="javascript:void(0)" onclick="openQuickAddModal('@Url.Action("Create", "Aulas")', 'IdAula')" class="text-decoration-none ms-1" title="Nueva Aula">
                                        <i class='bx bx-plus fw-bold'></i>
                                    </a>
                                </div>
                                <select asp-for="IdAula" class="form-control" asp-items="ViewBag.IdAula">
                                    <option value="">-- Seleccione Aula --</option>
                                </select>
                                <span asp-validation-for="IdAula" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <label asp-for="IdGrupo" class="form-label mb-0 d-flex align-items-center">
                                        <i class='bx bx-group me-1'></i> Grupo
                                    </label>
                                    <a href="javascript:void(0)" onclick="openQuickAddModal('@Url.Action("Create", "Grupos")', 'IdGrupo')" class="text-decoration-none ms-1" title="Nuevo Grupo">
                                        <i class='bx bx-plus fw-bold'></i>
                                    </a>
                                </div>
                                <select asp-for="IdGrupo" class="form-control" asp-items="ViewBag.IdGrupo">
                                    <option value="">-- Seleccione Grupo --</option>
                                </select>
                                <span asp-validation-for="IdGrupo" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label asp-for="DiaSemana" class="form-label d-flex align-items-center">
                                    <i class='bx bx-calendar-event me-1'></i> Día
                                </label>
                                <select asp-for="DiaSemana" class="form-control">
                                    <option value="Lunes">Lunes</option>
                                    <option value="Martes">Martes</option>
                                    <option value="Miércoles">Miércoles</option>
                                    <option value="Jueves">Jueves</option>
                                    <option value="Viernes">Viernes</option>
                                    <option value="Sábado">Sábado</option>
                                </select>
                                <span asp-validation-for="DiaSemana" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label asp-for="HoraInicio" class="form-label d-flex align-items-center">
                                    <i class='bx bx-time me-1'></i> Inicio
                                </label>
                                <input asp-for="HoraInicio" class="form-control" type="time" />
                                <span asp-validation-for="HoraInicio" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label asp-for="HoraFin" class="form-label d-flex align-items-center">
                                    <i class='bx bx-time-five me-1'></i> Fin
                                </label>
                                <input asp-for="HoraFin" class="form-control" type="time" />
                                <span asp-validation-for="HoraFin" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4 border-top pt-4">
                        <a asp-action="Index" class="btn btn-light px-4">
                            <i class='bx bx-chevron-left'></i> Volver
                        </a>
                        <button type="submit" class="btn btn-primary px-5 fw-bold">
                            <i class='bx bx-plus me-1'></i> Asignar Horario
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Genérico para Creación Rápida -->
<div class="modal fade" id="quickAddModal" tabindex="-1" aria-labelledby="quickAddModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content shadow-lg border-0 rounded-4">
            <div class="modal-header border-bottom-0 pb-0 pt-4 px-4 d-flex align-items-center">
                <i id="modalIcon" class='bx bx-plus-circle text-primary me-2' style="font-size: 1.5rem;"></i>
                <h5 class="modal-title fw-bold mb-0" id="quickAddModalLabel">Agregar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" id="modalContentContainer">
                <div class="p-5 text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Refinamientos para el contenido cargado en el Modal */
    #modalContentContainer .card {
        border: none !important;
        box-shadow: none !important;
        margin-top: 0 !important;
    }
    #modalContentContainer .card-header {
        display: none !important; /* El título se maneja en el header del modal */
    }
    #modalContentContainer .card-body {
        padding: 0 !important;
    }
    #modalContentContainer .row, 
    #modalContentContainer .col-md-10, 
    #modalContentContainer .col-lg-7 {
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        max-width: 100% !important;
    }
    #modalContentContainer .btn-light {
        display: none !important; /* Ocultar botón 'Volver' en el modal */
    }
    #modalContentContainer .border-top {
        border-top: 1px solid var(--border-color) !important;
        margin-top: 1.5rem !important;
        padding-top: 1.5rem !important;
    }
    #modalContentContainer .btn-primary {
        width: 100% !important;
        padding-top: 0.75rem !important;
        padding-bottom: 0.75rem !important;
    }
</style>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        let currentTargetSelect = null;

        function openQuickAddModal(url, targetSelect) {
            currentTargetSelect = targetSelect;
            const modalElement = document.getElementById('quickAddModal');
            const modal = new bootstrap.Modal(modalElement);
            const container = document.getElementById('modalContentContainer');
            const modalTitle = document.getElementById('quickAddModalLabel');
            const modalIcon = document.getElementById('modalIcon');
            
            // Títulos e iconos por defecto basados en el target
            const titles = {
                'IdDocente': { text: 'Nuevo Docente', icon: 'bx-user-plus' },
                'IdAsignatura': { text: 'Nueva Asignatura', icon: 'bx-book-add' },
                'IdAula': { text: 'Nueva Aula', icon: 'bx-door-open' },
                'IdGrupo': { text: 'Nuevo Grupo', icon: 'bx-group-plus' }
            };

            const config = titles[targetSelect] || { text: 'Agregar', icon: 'bx-plus-circle' };
            modalTitle.innerText = config.text;
            modalIcon.className = `bx ${config.icon} text-primary me-2`;

            // Limpiar contenido previo y mostrar spinner
            container.innerHTML = '<div class="p-5 text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">Cargando formulario...</p></div>';
            
            modal.show();

            fetch(url, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.text())
            .then(html => {
                container.innerHTML = html;
                setupModalForm(url);
            })
            .catch(error => {
                console.error('Error carregando modal:', error);
                container.innerHTML = '<div class="alert alert-danger">Error al cargar el formulario.</div>';
            });
        }

        function setupModalForm(baseUri) {
            const container = document.getElementById('modalContentContainer');
            const form = container.querySelector('form');
            if (!form) return;

            // Ocultar botones de navegación originales (Volver)
            const backBtn = container.querySelector('a.btn-light');
            if (backBtn) backBtn.style.display = 'none';
            
            // Ajustar el header si es un card
            const card = container.querySelector('.card');
            if (card) {
                card.classList.remove('shadow-sm', 'mt-4');
                card.style.border = 'none';
            }

            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(form);

                fetch(form.action || baseUri, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => {
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        return response.json().then(data => ({ isJson: true, data }));
                    } else {
                        return response.text().then(html => ({ isJson: false, html }));
                    }
                })
                .then(res => {
                    if (res.isJson && res.data.success) {
                        // Éxito: Cerrar modal y actualizar dropdown
                        const select = document.getElementById(currentTargetSelect);
                        const newOption = new Option(res.data.name, res.data.id, true, true);
                        select.add(newOption);
                        $(select).trigger('change'); // Por si usa select2 u otros
                        
                        bootstrap.Modal.getInstance(document.getElementById('quickAddModal')).hide();
                    } else {
                        // Error de validación: Recargar contenido del modal con el HTML devuelto
                        container.innerHTML = res.html;
                        setupModalForm(baseUri);
                    }
                })
                .catch(error => {
                    console.error('Error enviando formulario:', error);
                });
            });
        }
    </script>
}
